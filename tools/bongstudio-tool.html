<!-- REPLACE WHOLE FILE: /tools/bongstudio-tool.html (ho·∫∑c ƒë∆∞·ªùng d·∫´n ƒëang d√πng) -->
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
  <title>Bongstudio Product Builder v1.2 ‚Äî JSON + HTML + Poster + WebP</title>
  <meta name="robots" content="noindex,follow"/>
  <style>
    :root{
      --bg:#050814;
      --fg:#f5f7ff;
      --muted:#9aa4c6;
      --card:#0d1224;
      --accent:#7b8cff;
      --accent-soft:rgba(123,140,255,.12);
      --border:#23294a;
      --danger:#f97373;
      --ok:#34d399;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#161b3a 0,#050814 55%,#020308 100%);
      color:var(--fg);
      -webkit-font-smoothing:antialiased;
    }
    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:16px;
    }
    h1{
      font-size:1.5rem;
      margin:0 0 4px;
      letter-spacing:.03em;
    }
    .sub{
      font-size:.85rem;
      color:var(--muted);
      margin-bottom:16px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px 14px 10px;
      margin-bottom:12px;
      box-shadow:0 18px 45px rgba(0,0,0,.4);
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .card-title{
      font-size:.95rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pill{
      font-size:.7rem;
      padding:2px 8px;
      border-radius:999px;
      background:var(--accent-soft);
      color:var(--accent);
      border:1px solid rgba(123,140,255,.35);
      text-transform:uppercase;
      letter-spacing:.06em;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
    }
    @media(max-width:768px){
      .grid{grid-template-columns:1fr}
    }
    label{
      font-size:.8rem;
      color:var(--muted);
      margin-bottom:2px;
      display:block;
    }
    input,select,textarea{
      width:100%;
      border-radius:9px;
      border:1px solid var(--border);
      background:#070b18;
      color:var(--fg);
      padding:7px 9px;
      font:inherit;
      font-size:.85rem;
      outline:none;
      transition:border .13s,box-shadow .13s,background .13s;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(123,140,255,.45);
      background:#080e20;
    }
    textarea{
      min-height:120px;
      resize:vertical;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      line-height:1.5;
      white-space:pre;
    }
    .row{
      margin-bottom:8px;
    }
    .hint{
      font-size:.75rem;
      color:var(--muted);
      margin-top:1px;
    }
    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }
    button{
      border-radius:999px;
      border:1px solid var(--border);
      background:linear-gradient(135deg,#3d4fff,#7b8cff);
      color:#f9fbff;
      padding:6px 14px;
      font-size:.8rem;
      font-weight:600;
      letter-spacing:.04em;
      text-transform:uppercase;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 12px 25px rgba(17,24,39,.45);
      transition:transform .12s,box-shadow .12s,opacity .12s;
    }
    button.secondary{
      background:transparent;
      color:var(--muted);
      box-shadow:none;
      border-style:dashed;
    }
    button:hover{
      transform:translateY(-1px);
      box-shadow:0 16px 40px rgba(15,23,42,.65);
    }
    button:active{
      transform:translateY(0);
      box-shadow:0 8px 18px rgba(15,23,42,.5);
    }
    .badge-ok{color:var(--ok);font-size:.75rem;}
    .badge-err{color:var(--danger);font-size:.75rem;}
    .preview-img{
      width:100%;
      max-height:220px;
      object-fit:cover;
      border-radius:10px;
      border:1px solid var(--border);
      background:#020309;
    }
    .split-2{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,0.9fr);
      gap:8px;
    }
    @media(max-width:900px){
      .split-2{grid-template-columns:1fr}
    }
    .mono-small{
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:.75rem;
      color:var(--muted);
    }
    .footer{
      margin-top:12px;
      font-size:.75rem;
      color:var(--muted);
      text-align:center;
    }
    .tagline{
      font-size:.8rem;
      color:var(--muted);
    }

    /* Kh·ªëi ·∫£nh share */
    .share-layout{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,0.9fr);
      gap:8px;
    }
    @media(max-width:900px){
      .share-layout{grid-template-columns:1fr}
    }
    .canvas-box{
      border-radius:14px;
      border:1px dashed var(--border);
      background:#020414;
      padding:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:220px;
    }
    canvas{
      max-width:100%;
      height:auto;
      display:block;
      border-radius:12px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>üîß Bongstudio Product Builder v1.2</h1>
  <div class="sub">
    Nh·∫≠p th√¥ng tin s·∫£n ph·∫©m ‚ûù tool t·ª± sinh <b>slug chu·∫©n</b>, block <b>JSON</b>, ƒëo·∫°n <b>HTML card</b>,  
    <b>poster share</b> v√† <b>·∫£nh WebP</b> ƒë·ªÉ up repo.
  </div>

  <!-- KH·ªêI 1: INPUT TH√îNG TIN -->
  <div class="card">
    <div class="card-header">
      <div class="card-title">
        1. Th√¥ng tin s·∫£n ph·∫©m
        <span class="pill">Input</span>
      </div>
      <div class="tagline">Gi·ªØ m·∫°ch chu·∫©n chung cho to√†n b·ªô Bongstudio.</div>
    </div>

    <div class="grid">
      <div class="row">
        <label for="merchant">S√†n / Ngu·ªìn</label>
        <select id="merchant">
          <option value="shopee">Shopee</option>
          <option value="lazada">Lazada</option>
          <option value="tiktok">TikTok</option>
          <option value="tiki">Tiki</option>
          <option value="other">Kh√°c / T·ª± nh·∫≠p</option>
        </select>
        <div class="hint">D√πng ƒë·ªÉ g·ª£i √Ω tag & m√¥ t·∫£.</div>
      </div>

      <div class="row">
        <label for="originUrl">Link g·ªëc s·∫£n ph·∫©m</label>
        <input id="originUrl" placeholder="D√°n link s·∫£n ph·∫©m tr√™n s√†n‚Ä¶"/>
        <div class="hint">C√≥ th·ªÉ l√† link d√†i, tool kh√¥ng s·ª≠a link ‚Äî ch·ªâ gi·ªØ l·∫°i.</div>
      </div>

      <div class="row">
        <label for="title">T√™n s·∫£n ph·∫©m (Title)</label>
        <input id="title" placeholder="V√≠ d·ª•: √Åo kho√°c cardigan len d√°ng r·ªông‚Ä¶"/>
        <div class="hint">C√†ng r√µ r√†ng c√†ng d·ªÖ SEO & CTR.</div>
      </div>

      <div class="row">
        <label for="priceNow">Gi√° b√°n hi·ªán t·∫°i (VNƒê)</label>
        <input id="priceNow" placeholder="V√≠ d·ª•: 159000 ho·∫∑c 159.000"/>
        <div class="hint">Tool t·ª± b·ªè d·∫•u ch·∫•m, chuy·ªÉn sang s·ªë.</div>
      </div>

      <div class="row">
        <label for="priceOld">Gi√° g·ªëc / Gi√° so s√°nh (tu·ª≥ ch·ªçn)</label>
        <input id="priceOld" placeholder="V√≠ d·ª•: 259000"/>
        <div class="hint">ƒê·ªÉ show ‚Äúgi·∫£m bao nhi√™u %‚Äù.</div>
      </div>

      <div class="row">
        <label for="category">Danh m·ª•c ch√≠nh (Bongstudio)</label>
        <select id="category">
          <option value="gia-dung-decor">Gia d·ª•ng, decor nh√† c·ª≠a</option>
          <option value="thoi-trang-nu">Th·ªùi trang n·ªØ</option>
          <option value="thoi-trang-nam">Th·ªùi trang nam</option>
          <option value="quan-ao-em-be">Qu·∫ßn √°o em b√©</option>
          <option value="suc-khoe-tpcn">S·ª©c kho·∫ª, th·ª±c ph·∫©m ch·ª©c nƒÉng</option>
          <option value="sach">S√°ch</option>
          <option value="do-an">ƒê·ªì ƒÉn</option>
        </select>
        <div class="hint">Slug danh m·ª•c ƒë√£ ƒë∆∞·ª£c chu·∫©n ho√° s·∫µn.</div>
      </div>

      <div class="row">
        <label for="sku">SKU / M√£ chu·∫©n Bongstudio</label>
        <input id="sku" placeholder="T·ª± sinh t·ª´ t√™n s·∫£n ph·∫©m ho·∫∑c t·ª± nh·∫≠p‚Ä¶"/>
        <div class="actions">
          <button type="button" id="btnSlug">T·∫°o slug t·ª´ t√™n</button>
        </div>
        <div class="hint mono-small" id="slugHint"></div>
      </div>

      <div class="row">
        <label for="thumbUrl">Link ·∫£nh ƒë·∫°i di·ªán (thumb ‚Äì tu·ª≥ ch·ªçn)</label>
        <input id="thumbUrl" placeholder="D√°n link ·∫£nh s·∫£n ph·∫©m (t·∫°m th·ªùi)‚Ä¶"/>
        <div class="hint">Ch·ªâ d√πng ƒë·ªÉ preview, <b>kh√¥ng</b> v·∫Ω v√†o poster ƒë·ªÉ tr√°nh l·ªói CORS.</div>
      </div>

      <div class="row">
        <label for="uploadFile">Ch·ªçn ·∫£nh s·∫£n ph·∫©m t·ª´ m√°y (tu·ª≥ ch·ªçn)</label>
        <input id="uploadFile" type="file" accept="image/*"/>
        <div class="hint">
          ·∫¢nh n√†y s·∫Ω ƒë∆∞·ª£c v·∫Ω v√†o poster & d√πng ƒë·ªÉ t·∫°o WebP thumb vu√¥ng, ti·ªán up l√™n repo.
          File ch·ªâ x·ª≠ l√Ω t·∫°i tr√¨nh duy·ªát, kh√¥ng g·ª≠i ƒëi ƒë√¢u.
        </div>
      </div>

      <div class="row">
        <label for="shortDesc">M√¥ t·∫£ ng·∫Øn (Short description)</label>
        <textarea id="shortDesc" placeholder="N·∫øu ƒë·ªÉ tr·ªëng, tool s·∫Ω g·ª£i √Ω m√¥ t·∫£ theo danh m·ª•c & s√†n."></textarea>
      </div>
    </div>

    <div class="actions">
      <button type="button" id="btnGenerate">T·∫°o JSON + HTML</button>
      <button type="button" class="secondary" id="btnClear">Xo√° form</button>
    </div>
  </div>

  <!-- KH·ªêI 2: JSON -->
  <div class="card">
    <div class="card-header">
      <div class="card-title">
        2. JSON s·∫£n ph·∫©m
        <span class="pill">Output ¬∑ JSON</span>
      </div>
      <span id="statusJson" class="badge-err"></span>
    </div>

    <div class="split-2">
      <div>
        <textarea id="jsonOutput" readonly placeholder="{ ... }"></textarea>
        <div class="actions">
          <button type="button" id="btnCopyJson">Copy JSON</button>
        </div>
      </div>
      <div>
        <label for="previewImg">Preview ·∫£nh (URL ho·∫∑c file local):</label>
        <img id="previewImg" class="preview-img" alt="Preview ·∫£nh s·∫£n ph·∫©m"/>
        <div class="hint">
          N·∫øu ƒë√£ ch·ªçn file ·∫£nh t·ª´ m√°y, preview s·∫Ω ∆∞u ti√™n hi·ªÉn th·ªã ·∫£nh ƒë√≥.
        </div>
      </div>
    </div>
  </div>

  <!-- KH·ªêI 3: HTML CARD -->
  <div class="card">
    <div class="card-header">
      <div class="card-title">
        3. ƒêo·∫°n HTML card g·ª£i √Ω
        <span class="pill">Output ¬∑ HTML</span>
      </div>
      <span class="mono-small">D√°n v√†o c√°c file danh m·ª•c / g.html</span>
    </div>

    <textarea id="htmlOutput" readonly placeholder="&lt;article class=&quot;product-card&quot; ..."></textarea>
    <div class="actions">
      <button type="button" id="btnCopyHtml">Copy HTML</button>
    </div>
    <div class="hint">
      C·∫•u tr√∫c card gi·ªØ m·ª©c ‚Äúan to√†n‚Äù ‚Äî sau n√†y n·∫øu layout Bongstudio thay ƒë·ªïi,
      ch·ªâ c·∫ßn ch·ªânh l·∫°i CSS/global class m√† kh√¥ng ph·∫£i s·ª≠a t·ª´ng s·∫£n ph·∫©m.
    </div>
  </div>

  <!-- KH·ªêI 4: POSTER + WEBP -->
  <div class="card">
    <div class="card-header">
      <div class="card-title">
        4. Poster share + ·∫¢nh WebP
        <span class="pill">Output ¬∑ Image</span>
      </div>
      <span id="shareStatus" class="badge-err"></span>
    </div>

    <div class="share-layout">
      <div>
        <div class="row">
          <label for="shareTitle">Ti√™u ƒë·ªÅ l·ªõn tr√™n poster</label>
          <input id="shareTitle" placeholder="N·∫øu b·ªè tr·ªëng s·∫Ω d√πng t√™n s·∫£n ph·∫©m"/>
          <div class="hint">T·ªëi ƒëa 2‚Äì3 d√≤ng, ng·∫Øn g·ªçn, d·ªÖ ƒë·ªçc.</div>
        </div>
        <div class="row">
          <label for="shareTagline">D√≤ng m√¥ t·∫£ nh·ªè ph√≠a d∆∞·ªõi</label>
          <input id="shareTagline" placeholder="V√≠ d·ª•: Check gi√° & ∆∞u ƒë√£i m·ªõi nh·∫•t tr√™n Shopee"/>
        </div>
        <div class="row">
          <label for="shareBadge">Badge n·ªïi b·∫≠t (g√≥c ph·∫£i)</label>
          <input id="shareBadge" placeholder="V√≠ d·ª•: Kho·∫£ng 159K / Deal h√¥m nay"/>
        </div>
        <div class="row">
          <label for="shareSize">T·ªâ l·ªá poster</label>
          <select id="shareSize">
            <option value="square">Vu√¥ng 1:1 (1080√ó1080) ‚Äî post th∆∞·ªùng</option>
            <option value="4x5">D·ªçc 4:5 (1080√ó1350) ‚Äî feed t·ªëi ∆∞u</option>
            <option value="story">Story 9:16 (1080√ó1920)</option>
          </select>
        </div>
        <div class="actions">
          <button type="button" id="btnRenderShare">V·∫Ω l·∫°i poster</button>
          <button type="button" id="btnDownloadShareWebp">T·∫£i poster WebP</button>
          <button type="button" class="secondary" id="btnDownloadShare">T·∫£i poster PNG</button>
          <button type="button" class="secondary" id="btnDownloadThumbWebp">WebP thumb vu√¥ng</button>
        </div>
        <div class="hint">
          Poster d√πng n·ªÅn gradient + text, c√≥ th·ªÉ ch√®n ·∫£nh s·∫£n ph·∫©m (file local).
          WebP thumb vu√¥ng l√† ·∫£nh s·∫£n ph·∫©m s·∫°ch (kh√¥ng ch·ªØ), k√≠ch th∆∞·ªõc ~800√ó800 ƒë·ªÉ up l√™n repo.
        </div>
      </div>
      <div>
        <div class="canvas-box">
          <canvas id="shareCanvas"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    Bongstudio Tool v1.2 ‚Äî ch·∫°y ho√†n to√†n tr√™n tr√¨nh duy·ªát, kh√¥ng g·ªçi API.  
    B∆∞·ªõc sau: n·ªëi m·∫°ch v·ªõi worker ƒë·ªÉ publish JSON + ·∫£nh l√™n repo t·ª± ƒë·ªông.
  </div>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  let lastData = null;
  let uploadedImg = null;

  function slugify(str){
    if(!str) return "";
    let s = str.normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    s = s.toLowerCase();
    s = s.replace(/[^a-z0-9]+/g,"-");
    s = s.replace(/^-+|-+$/g,"");
    s = s.replace(/-+/g,"-");
    return s;
  }

  function cleanPrice(val){
    if(!val) return null;
    const num = parseInt(String(val).replace(/[^\d]/g,""),10);
    return Number.isFinite(num) ? num : null;
  }

  const DESC_TEMPLATES = {
    "gia-dung-decor": "S·∫£n ph·∫©m gia d·ª•ng/ decor ph√π h·ª£p nhi·ªÅu kh√¥ng gian, ∆∞u ti√™n ƒë·ªô b·ªÅn v√† t√≠nh ti·ªán d·ª•ng, gi√∫p g√≥c nh√† c·ªßa b·∫°n g·ªçn g√†ng v√† ƒë·∫πp m·∫Øt h∆°n.",
    "thoi-trang-nu": "Item d·ªÖ ph·ªëi ƒë·ªì, l√™n d√°ng t√¥n form, ph√π h·ª£p m·∫∑c ƒëi l√†m, ƒëi ch∆°i, ch·∫•t li·ªáu tho·∫£i m√°i v√† gi·ªØ form ·ªïn sau nhi·ªÅu l·∫ßn gi·∫∑t.",
    "thoi-trang-nam": "Thi·∫øt k·∫ø ƒë∆°n gi·∫£n, d·ªÖ ph·ªëi v·ªõi qu·∫ßn jeans/ kaki, th√≠ch h·ª£p ƒëi l√†m, ƒëi ch∆°i, ch·∫•t li·ªáu tho√°ng v√† √≠t nhƒÉn.",
    "quan-ao-em-be": "Ch·∫•t li·ªáu m·ªÅm, ∆∞u ti√™n an to√†n cho da b√©, ƒë∆∞·ªùng may h·∫°n ch·∫ø c·ªç x√°t, ph√π h·ª£p cho sinh ho·∫°t h·∫±ng ng√†y.",
    "suc-khoe-tpcn": "S·∫£n ph·∫©m thu·ªôc nh√≥m h·ªó tr·ª£ s·ª©c kho·∫ª, n√™n ƒë·ªçc k·ªπ h∆∞·ªõng d·∫´n s·ª≠ d·ª•ng v√† tham kh·∫£o √Ω ki·∫øn chuy√™n gia khi c·∫ßn.",
    "sach": "ƒê·∫ßu s√°ch d·ªÖ ƒë·ªçc, ph√π h·ª£p ƒë·ªÉ th∆∞ gi√£n v√† b·ªï sung ki·∫øn th·ª©c nh·∫π nh√†ng trong ng√†y.",
    "do-an": "S·∫£n ph·∫©m ƒÉn u·ªëng ti·ªán l·ª£i, ph√π h·ª£p l√†m snack/ b·ªØa nh·∫π, ch√∫ √Ω xem k·ªπ h·∫°n s·ª≠ d·ª•ng v√† h∆∞·ªõng d·∫´n b·∫£o qu·∫£n tr√™n bao b√¨."
  };

  function merchantLabel(code){
    switch(code){
      case "shopee": return "Shopee";
      case "lazada": return "Lazada";
      case "tiktok": return "TikTok Shop";
      case "tiki":   return "Tiki";
      default:       return "Ngu·ªìn kh√°c";
    }
  }

  function buildShortDesc(cat, merchant, current){
    if(current && current.trim().length >= 16) return current.trim();
    const base = DESC_TEMPLATES[cat] || "S·∫£n ph·∫©m ƒë∆∞·ª£c Bongstudio ch·ªçn l·ªçc, ∆∞u ti√™n tr·∫£i nghi·ªám d√πng th·ª±c t·∫ø v√† m·ª©c gi√° h·ª£p l√Ω.";
    const m = merchantLabel(merchant);
    return base + " ƒêang ƒë∆∞·ª£c ph√¢n ph·ªëi tr√™n " + m + ", theo d√µi gi√°/ ∆∞u ƒë√£i tr·ª±c ti·∫øp tr√™n trang s·∫£n ph·∫©m.";
  }

  function buildJson(){
    const merchant = $("merchant").value;
    const originUrl = $("originUrl").value.trim();
    const title = $("title").value.trim();
    const priceNow = cleanPrice($("priceNow").value);
    const priceOld = cleanPrice($("priceOld").value);
    const category = $("category").value;
    let sku = $("sku").value.trim();
    const thumbUrl = $("thumbUrl").value.trim();
    const shortDescRaw = $("shortDesc").value;

    if(!title || !originUrl){
      $("statusJson").textContent = "C·∫ßn t·ªëi thi·ªÉu: T√™n s·∫£n ph·∫©m + Link g·ªëc.";
      $("statusJson").className = "badge-err";
      return null;
    }

    if(!sku){
      sku = slugify(title);
      $("sku").value = sku;
      $("slugHint").textContent = "ƒê√£ t·ª± sinh SKU t·ª´ t√™n: " + sku;
    }

    const shortDesc = buildShortDesc(category, merchant, shortDescRaw);
    $("shortDesc").value = shortDesc;

    const today = new Date();
    const created = today.toISOString().slice(0,10);

    const tags = [
      "bongstudio",
      merchant,
      category,
      sku
    ].filter(Boolean);

    const obj = {
      sku,
      title,
      origin_url: originUrl,
      merchant,
      category,
      price: priceNow,
      price_old: priceOld,
      thumb: thumbUrl || null,
      short_desc: shortDesc,
      tags,
      note: "Bongstudio Tool v1.2",
      created_at: created
    };

    $("statusJson").textContent = "JSON ƒë√£ sinh xong (" + created + ").";
    $("statusJson").className = "badge-ok";

    return obj;
  }

  function buildHtmlCard(data){
    if(!data) return "";
    const priceNow = data.price ? data.price.toLocaleString("vi-VN") + "‚Ç´" : "Li√™n h·ªá";
    const priceOld = data.price_old ? data.price_old.toLocaleString("vi-VN") + "‚Ç´" : "";
    const merchantText = merchantLabel(data.merchant);

    return (
`<article class="product-card" data-sku="${data.sku}" data-merchant="${data.merchant}" data-category="${data.category}">
  <a class="product-link" href="${data.origin_url}" target="_blank" rel="nofollow noopener">
    <div class="product-thumb">
      <img src="${data.thumb || ""}" alt="${data.title.replace(/"/g,"&quot;")}" loading="lazy"/>
      <span class="product-merchant">${merchantText}</span>
    </div>
    <div class="product-body">
      <h3 class="product-title">${data.title}</h3>
      <p class="product-desc">${data.short_desc}</p>
      <div class="product-prices">
        <span class="price-now">${priceNow}</span>${
          priceOld ? `\n        <span class="price-old">${priceOld}</span>` : ""
        }
      </div>
      <div class="product-cta">
        <span class="btn-buy">Xem ∆∞u ƒë√£i tr√™n ${merchantText}</span>
      </div>
    </div>
  </a>
</article>`
    );
  }

  function updateShareFieldsFromData(data){
    if(!$("shareTitle")) return;
    if(!$("shareTitle").value){
      $("shareTitle").value = data.title;
    }
    if(!$("shareTagline").value){
      $("shareTagline").value = "Deal t·ª´ " + merchantLabel(data.merchant) + " ‚Ä¢ " + (data.category || "Bongstudio");
    }
    if(!$("shareBadge").value){
      if(data.price){
        const k = Math.round(data.price / 1000);
        $("shareBadge").value = "Kho·∫£ng " + k + "K";
      }else{
        $("shareBadge").value = "∆Øu ƒë√£i theo th·ªùi ƒëi·ªÉm";
      }
    }
  }

  function wrapText(ctx, text, x, y, maxWidth, lineHeight, maxLines){
    if(!text) return y;
    const words = text.split(/\s+/);
    let line = "";
    let lineCount = 0;
    for(let n=0;n<words.length;n++){
      const testLine = line ? line + " " + words[n] : words[n];
      const metrics = ctx.measureText(testLine);
      if(metrics.width > maxWidth && n>0){
        ctx.fillText(line, x, y);
        line = words[n];
        y += lineHeight;
        lineCount++;
        if(maxLines && lineCount >= maxLines - 1){
          const remaining = words.slice(n).join(" ");
          let ell = remaining;
          while(ctx.measureText(ell + "‚Ä¶").width > maxWidth && ell.length > 3){
            ell = ell.slice(0,-4);
          }
          ctx.fillText(ell + "‚Ä¶", x, y);
          return y;
        }
      }else{
        line = testLine;
      }
    }
    if(line){
      ctx.fillText(line,x,y);
    }
    return y;
  }

  function roundedRect(ctx,x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.lineTo(x+w-r,y);
    ctx.quadraticCurveTo(x+w,y,x+w,y+r);
    ctx.lineTo(x+w,y+h-r);
    ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
    ctx.lineTo(x+r,y+h);
    ctx.quadraticCurveTo(x,y+h,x,y+h-r);
    ctx.lineTo(x,y+r);
    ctx.quadraticCurveTo(x,y,x+r,y);
    ctx.closePath();
  }

  function renderShareImage(){
    const canvas = $("shareCanvas");
    const statusEl = $("shareStatus");
    const shareTitle = $("shareTitle").value.trim();
    const shareTagline = $("shareTagline").value.trim();
    const shareBadge = $("shareBadge").value.trim();
    const size = $("shareSize").value;
    const data = lastData || buildJson();

    if(!data){
      statusEl.textContent = "H√£y t·∫°o JSON (b·∫•m T·∫°o JSON + HTML) tr∆∞·ªõc khi v·∫Ω poster.";
      statusEl.className = "badge-err";
      return;
    }

    let w = 1080, h = 1080;
    if(size === "4x5"){ h = 1350; }
    else if(size === "story"){ h = 1920; }

    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext("2d");

    // N·ªÅn gradient
    const grad = ctx.createLinearGradient(0,0,w,h);
    grad.addColorStop(0,"#020617");
    grad.addColorStop(0.45,"#111827");
    grad.addColorStop(1,"#1d233b");
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,w,h);

    // V√πng glow tr√≤n
    ctx.fillStyle = "rgba(96,165,250,0.35)";
    const centerX = w*0.72;
    const centerY = h*0.22;
    const radius = Math.min(w,h)*0.22;
    ctx.beginPath();
    ctx.arc(centerX,centerY,radius,0,Math.PI*2);
    ctx.fill();

    // Card ch√≠nh
    const margin = w*0.08;
    const top = h*0.22;
    const cardW = w - margin*2;
    const cardH = h*0.46;
    roundedRect(ctx, margin, top, cardW, cardH, w*0.04);
    ctx.fillStyle = "rgba(15,23,42,0.92)";
    ctx.fill();
    ctx.strokeStyle = "rgba(129,140,248,0.65)";
    ctx.lineWidth = 2;
    ctx.stroke();

    const hasImg = !!uploadedImg;

    const innerX = margin + w*0.05;
    let textY = top + w*0.09;

    // V√πng ·∫£nh s·∫£n ph·∫©m (n·∫øu c√≥)
    const imgBoxW = cardW*0.34;
    const imgBoxH = cardH*0.76;
    const imgBoxX = margin + cardW - imgBoxW - w*0.05;
    const imgBoxY = top + w*0.06;

    if(hasImg){
      ctx.save();
      roundedRect(ctx, imgBoxX, imgBoxY, imgBoxW, imgBoxH, w*0.03);
      ctx.clip();
      ctx.fillStyle = "#020617";
      ctx.fillRect(imgBoxX, imgBoxY, imgBoxW, imgBoxH);

      const iw = uploadedImg.width;
      const ih = uploadedImg.height;
      const scale = Math.max(imgBoxW/iw, imgBoxH/ih);
      const dw = iw*scale;
      const dh = ih*scale;
      const dx = imgBoxX + (imgBoxW - dw)/2;
      const dy = imgBoxY + (imgBoxH - dh)/2;
      ctx.drawImage(uploadedImg, dx, dy, dw, dh);
      ctx.restore();

      ctx.strokeStyle = "rgba(248,250,252,0.35)";
      ctx.lineWidth = 2;
      roundedRect(ctx, imgBoxX, imgBoxY, imgBoxW, imgBoxH, w*0.03);
      ctx.stroke();
    }

    // Tag s√†n + danh m·ª•c
    ctx.font = "500 " + Math.round(w*0.022) + "px system-ui";
    ctx.fillStyle = "#e5e7eb";
    const tag = merchantLabel(data.merchant) + " ‚Ä¢ " + (data.category || "");
    ctx.fillText(tag, innerX, textY);
    textY += w*0.04;

    // Ti√™u ƒë·ªÅ l·ªõn
    ctx.font = "700 " + Math.round(w*0.045) + "px system-ui";
    ctx.fillStyle = "#f9fafb";
    const titleText = shareTitle || data.title;
    const textMaxWidth = hasImg ? (imgBoxX - innerX - w*0.04) : (cardW - w*0.12);
    textY = wrapText(ctx, titleText, innerX, textY, textMaxWidth, w*0.055, 3);
    textY += w*0.03;

    // Gi√°
    ctx.font = "700 " + Math.round(w*0.04) + "px system-ui";
    ctx.fillStyle = "#bfdbfe";
    const priceNow = data.price ? data.price.toLocaleString("vi-VN") + "‚Ç´" : "Gi√° c·∫≠p nh·∫≠t tr√™n s√†n";
    ctx.fillText(priceNow, innerX, textY);

    if(data.price_old){
      ctx.font = "500 " + Math.round(w*0.025) + "px system-ui";
      ctx.fillStyle = "#9ca3af";
      const old = data.price_old.toLocaleString("vi-VN") + "‚Ç´";
      const widthNow = ctx.measureText(priceNow).width;
      ctx.fillText(old, innerX + widthNow + 16, textY);
      const oldWidth = ctx.measureText(old).width;
      ctx.strokeStyle = "#9ca3af";
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(innerX + widthNow + 16, textY - w*0.012);
      ctx.lineTo(innerX + widthNow + 16 + oldWidth, textY - w*0.012);
      ctx.stroke();
    }

    // Badge g√≥c ph·∫£i
    const badgeText = shareBadge || "S·∫£n ph·∫©m ch·ªçn l·ªçc";
    ctx.font = "600 " + Math.round(w*0.026) + "px system-ui";
    const badgeWidth = ctx.measureText(badgeText).width + w*0.06;
    const badgeHeight = w*0.06;
    const badgeX = margin + cardW - badgeWidth - w*0.04;
    const badgeY = top + cardH - badgeHeight - w*0.04;
    roundedRect(ctx, badgeX, badgeY, badgeWidth, badgeHeight, w*0.03);
    const gradBadge = ctx.createLinearGradient(badgeX, badgeY, badgeX+badgeWidth, badgeY+badgeHeight);
    gradBadge.addColorStop(0,"#4f46e5");
    gradBadge.addColorStop(1,"#22d3ee");
    ctx.fillStyle = gradBadge;
    ctx.fill();
    ctx.fillStyle = "#f9fafb";
    ctx.textBaseline = "middle";
    ctx.fillText(badgeText, badgeX + w*0.03, badgeY + badgeHeight/2);

    // D·∫£i brand ph√≠a d∆∞·ªõi
    const stripH = h*0.09;
    const stripY = h - stripH;
    ctx.fillStyle = "rgba(15,23,42,0.92)";
    ctx.fillRect(0, stripY, w, stripH);

    ctx.font = "600 " + Math.round(w*0.03) + "px system-ui";
    ctx.fillStyle = "#e5e7eb";
    ctx.textBaseline = "alphabetic";
    const brandText = "Bongstudio ‚Ä¢ S·∫£n ph·∫©m ch·ªçn l·ªçc";
    ctx.fillText(brandText, margin, stripY + stripH*0.55);

    ctx.font = "500 " + Math.round(w*0.022) + "px system-ui";
    ctx.fillStyle = "#9ca3af";
    const tagline = shareTagline || ("Check gi√° & ∆∞u ƒë√£i m·ªõi nh·∫•t tr·ª±c ti·∫øp tr√™n " + merchantLabel(data.merchant));
    wrapText(ctx, tagline, margin, stripY + stripH*0.8, w - margin*2, w*0.03, 2);

    // SKU nh·ªè g√≥c ph·∫£i
    ctx.font = "500 " + Math.round(w*0.02) + "px ui-monospace,monospace";
    ctx.textAlign = "right";
    ctx.fillStyle = "#6b7280";
    ctx.fillText(data.sku || "", w - margin, stripY + stripH*0.35);
    ctx.textAlign = "left";

    statusEl.textContent = "ƒê√£ v·∫Ω preview poster xong. C√≥ th·ªÉ t·∫£i PNG/WebP.";
    statusEl.className = "badge-ok";
  }

  function downloadSharePng(){
    const canvas = $("shareCanvas");
    const statusEl = $("shareStatus");
    if(!canvas.width || !canvas.height){
      statusEl.textContent = "Ch∆∞a c√≥ poster ƒë·ªÉ t·∫£i. B·∫•m V·∫Ω l·∫°i poster tr∆∞·ªõc.";
      statusEl.className = "badge-err";
      return;
    }
    try{
      const dataUrl = canvas.toDataURL("image/png");
      const data = lastData || buildJson() || {};
      const namePart = data.sku || "bongstudio";
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = namePart + "-poster.png";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      statusEl.textContent = "ƒê√£ y√™u c·∫ßu t·∫£i poster PNG.";
      statusEl.className = "badge-ok";
    }catch(e){
      statusEl.textContent = "Tr√¨nh duy·ªát ch·∫∑n t·∫£i poster PNG (toDataURL).";
      statusEl.className = "badge-err";
    }
  }

  function downloadShareWebp(){
    const canvas = $("shareCanvas");
    const statusEl = $("shareStatus");
    if(!canvas.width || !canvas.height){
      statusEl.textContent = "Ch∆∞a c√≥ poster ƒë·ªÉ t·∫£i. B·∫•m V·∫Ω l·∫°i poster tr∆∞·ªõc.";
      statusEl.className = "badge-err";
      return;
    }
    try{
      const dataUrl = canvas.toDataURL("image/webp",0.92);
      if(!dataUrl.startsWith("data:image/webp")){
        statusEl.textContent = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ WebP t·ª´ canvas. D√πng PNG ho·∫∑c th·ª≠ browser kh√°c.";
        statusEl.className = "badge-err";
        return;
      }
      const data = lastData || buildJson() || {};
      const namePart = data.sku || "bongstudio";
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = namePart + "-poster.webp";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      statusEl.textContent = "ƒê√£ y√™u c·∫ßu t·∫£i poster WebP.";
      statusEl.className = "badge-ok";
    }catch(e){
      statusEl.textContent = "Tr√¨nh duy·ªát ch·∫∑n t·∫£i poster WebP.";
      statusEl.className = "badge-err";
    }
  }

  function downloadThumbWebp(){
    const statusEl = $("shareStatus");
    if(!uploadedImg){
      statusEl.textContent = "Ch∆∞a ch·ªçn ·∫£nh s·∫£n ph·∫©m t·ª´ m√°y ƒë·ªÉ t·∫°o WebP thumb.";
      statusEl.className = "badge-err";
      return;
    }
    try{
      const size = 800;
      const canvas = document.createElement("canvas");
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#020617";
      ctx.fillRect(0,0,size,size);

      const iw = uploadedImg.width;
      const ih = uploadedImg.height;
      const scale = Math.max(size/iw, size/ih);
      const dw = iw*scale;
      const dh = ih*scale;
      const dx = (size - dw)/2;
      const dy = (size - dh)/2;
      ctx.drawImage(uploadedImg, dx, dy, dw, dh);

      const dataUrl = canvas.toDataURL("image/webp",0.92);
      if(!dataUrl.startsWith("data:image/webp")){
        statusEl.textContent = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ WebP thumb. Th·ª≠ browser kh√°c.";
        statusEl.className = "badge-err";
        return;
      }
      const data = lastData || buildJson() || {};
      const namePart = data.sku || "bongstudio-thumb";
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = namePart + "-thumb.webp";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      statusEl.textContent = "ƒê√£ t·∫£i WebP thumb vu√¥ng (800√ó800) ƒë·ªÉ up repo.";
      statusEl.className = "badge-ok";
    }catch(e){
      statusEl.textContent = "L·ªói khi t·∫°o WebP thumb.";
      statusEl.className = "badge-err";
    }
  }

  // --- Event handlers ---

  $("btnSlug").addEventListener("click", function(){
    const title = $("title").value;
    const s = slugify(title);
    $("sku").value = s;
    $("slugHint").textContent = s ? ("Slug ƒë·ªÅ xu·∫•t: " + s) : "Nh·∫≠p t√™n s·∫£n ph·∫©m tr∆∞·ªõc ƒë·ªÉ sinh slug.";
  });

  $("btnGenerate").addEventListener("click", function(){
    const data = buildJson();
    if(!data) return;
    lastData = data;
    $("jsonOutput").value = JSON.stringify(data, null, 2);

    if(!uploadedImg){
      if(data.thumb){
        $("previewImg").src = data.thumb;
      }else{
        $("previewImg").src = "";
      }
    }

    $("htmlOutput").value = buildHtmlCard(data);
    updateShareFieldsFromData(data);
  });

  $("btnClear").addEventListener("click", function(){
    [
      "originUrl","title","priceNow","priceOld","sku",
      "thumbUrl","shortDesc","shareTitle","shareTagline","shareBadge"
    ].forEach(id => {
      if($(id)) $(id).value = "";
    });
    const up = $("uploadFile");
    if(up) up.value = "";
    uploadedImg = null;
    lastData = null;
    $("jsonOutput").value = "";
    $("htmlOutput").value = "";
    $("previewImg").src = "";
    $("statusJson").textContent = "";
    $("slugHint").textContent = "";
    $("shareStatus").textContent = "";
    const canvas = $("shareCanvas");
    canvas.width = 0;
    canvas.height = 0;
  });

  function copyToClipboard(el, label){
    const value = el.value;
    if(!value){
      alert("Ch∆∞a c√≥ " + label + " ƒë·ªÉ copy.");
      return;
    }
    if(!navigator.clipboard || !navigator.clipboard.writeText){
      alert("Tr√¨nh duy·ªát kh√¥ng cho copy t·ª± ƒë·ªông, h√£y ch·ªçn v√† copy th·ªß c√¥ng.");
      return;
    }
    navigator.clipboard.writeText(value).then(()=>{
      alert("ƒê√£ copy " + label + " v√†o clipboard.");
    }).catch(()=>{
      alert("Tr√¨nh duy·ªát kh√¥ng cho copy t·ª± ƒë·ªông, h√£y ch·ªçn th·ªß c√¥ng.");
    });
  }

  $("btnCopyJson").addEventListener("click", function(){
    copyToClipboard($("jsonOutput"), "JSON");
  });
  $("btnCopyHtml").addEventListener("click", function(){
    copyToClipboard($("htmlOutput"), "HTML");
  });

  $("btnRenderShare").addEventListener("click", function(){
    if(!lastData){
      const data = buildJson();
      if(!data) return;
      lastData = data;
      updateShareFieldsFromData(data);
    }
    renderShareImage();
  });

  $("btnDownloadShare").addEventListener("click", function(){
    downloadSharePng();
  });

  $("btnDownloadShareWebp").addEventListener("click", function(){
    downloadShareWebp();
  });

  $("btnDownloadThumbWebp").addEventListener("click", function(){
    downloadThumbWebp();
  });

  // File ·∫£nh local
  const uploadInput = $("uploadFile");
  if(uploadInput){
    uploadInput.addEventListener("change", function(e){
      const file = e.target.files && e.target.files[0];
      if(!file){
        uploadedImg = null;
        return;
      }
      if(!file.type || !file.type.startsWith("image/")){
        alert("H√£y ch·ªçn ƒë√∫ng file ·∫£nh.");
        e.target.value = "";
        uploadedImg = null;
        return;
      }
      const reader = new FileReader();
      reader.onload = function(ev){
        const img = new Image();
        img.onload = function(){
          uploadedImg = img;
          $("previewImg").src = ev.target.result;
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });
  }

  // Kh·ªüi t·∫°o preview r·ªóng
  $("previewImg").src = "";
})();
</script>
</body>
</html>
