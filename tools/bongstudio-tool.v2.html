<!-- REPLACE WHOLE FILE: /tools/bongstudio-tool.html -->
<!-- MXD-TOOL v4.3.9-pro4 ‚Äî Bongstudio edition -->
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bongstudio Importer v4.3.9 ‚Äî PRO + Batch + Featured + Debug</title>
  <meta name="robots" content="noindex,follow"/>
  <style>
    :root{
      --bg:#f6f7fb; --fg:#0d1a2a; --muted:#4b5b70; --b:#ffffff; --line:#e4e8f1; --accent:#2563eb;
      --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --toast-bottom:12px;
    }
    body.dark{
      --bg:#0b0f14; --fg:#e8f0fb; --muted:#a7b4c2; --b:#152132; --line:#223348; --accent:#7cc4ff;
      --ok:#34d399; --warn:#f59e0b; --err:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    h1,h2{margin:16px 0 8px}
    h1{font-size:20px}
    h2{font-size:16px;color:var(--accent)}
    a{color:var(--accent)}
    .wrap{max-width:1160px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    .card{background:var(--b);border:1px solid var(--line);border-radius:12px;padding:14px}
    label{display:block;font-weight:700;margin:8px 0 6px}
    input,select,textarea,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#fff;color:#111}
    body.dark input,body.dark select,body.dark textarea{background:#0f1622;color:var(--fg);border-color:#2b3b52}
    textarea{min-height:70px;resize:vertical}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row>*{flex:1}
    .small{font-size:12px;color:var(--muted)}
    .btn{cursor:pointer;border:1px solid var(--line);background:#eef2ff}
    .btn:hover{background:#e3e9ff}
    body.dark .btn{background:#102235;border-color:#2b3b52}
    body.dark .btn:hover{background:#132a43}
    .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
    .btn.primary:hover{filter:brightness(0.98)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .drop{border:2px dashed var(--line);border-radius:12px;padding:16px;text-align:center;background:#fafbff}
    body.dark .drop{background:#0c1623;border-color:#3a5270}
    .drop.dragover{border-color:var(--accent)}
    .preview{display:flex;gap:12px;align-items:center}
    .preview img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
    .toast{position:fixed;right:12px;bottom:var(--toast-bottom);display:none;max-width:520px;background:var(--b);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 10px 30px #0008;z-index:99999;pointer-events:none}
    .toast.show{display:block}
    code.inline{background:#eef2ff;border:1px solid var(--line);border-radius:6px;padding:2px 6px}
    .badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:11px}
    table.queue{width:100%;border-collapse:separate;border-spacing:0 8px}
    table.queue th, table.queue td{font-size:13px;vertical-align:middle}
    table.queue th{text-align:left;padding:6px 8px}
    table.queue td{background:#fafbff;border:1px solid var(--line);padding:6px 8px}
    body.dark table.queue td{background:#0d1826;border-color:#23364b}
    table.queue td:first-child{border-radius:10px 0 0 10px}
    table.queue td:last-child{border-radius:0 10px 10px 0}
    .thumb{width:56px;height:56px;border-radius:8px;object-fit:cover;border:1px solid var(--line);background:#fff}
    .mini{display:flex;gap:6px;align-items:center}
    .w-auto{width:auto}
    .nowrap{white-space:nowrap}
    .btn.sm{padding:6px 10px;border-radius:8px}
    .controls{display:flex;gap:6px;flex-wrap:wrap}
    .status{font-size:12px}
    .muted{color:var(--muted)}
    .sticky-actions{position:sticky;bottom:0;background:linear-gradient(0deg,var(--bg) 60%,#0000);padding:12px;border-top:1px solid var(--line);z-index:9}
    .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .mode{width:auto}
    .warnbar{background:#fff5f5;border:1px solid #fecaca;color:#991b1b;border-radius:10px;padding:8px 10px;font-size:13px;margin:-6px 0 8px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1 id="title">Importer v4.3.9 <span class="pill">PRO</span> <span class="pill">Batch</span> <span class="pill">Featured</span> <span class="pill">Debug</span></h1>
    <div class="row w-auto" style="gap:6px">
      <button id="btnMode" class="btn mode" type="button">Dark mode</button>
      <button id="btnClearFormQuick" class="btn mode" type="button">üßπ Xo√° form</button>
      <button id="btnClearLog" class="btn mode" type="button">üßº Xo√° log</button>
    </div>
  </div>

  <div id="affWarn" class="warnbar" style="display:none">
    ‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh template affiliate ƒë√∫ng site n√†y. H√£y v√†o <b>C√†i ƒë·∫∑t</b> ‚Üí b·∫•m
    <b>T·ª± ƒë·ªông l·∫•y t·ª´ mxd-affiliate.js</b> ho·∫∑c d√°n th·ªß c√¥ng 3 template Shopee/Lazada/TikTok, r·ªìi <b>L∆∞u</b>.
  </div>

  <div class="card">
    <h2>1) C√†i ƒë·∫∑t</h2>
    <div class="grid g2">
      <div><label>Worker Base URL</label><input id="workerUrl" placeholder="https://&lt;worker&gt;.&lt;account&gt;.workers.dev"/></div>
      <div><label>X-Key (header b·∫£o v·ªá Worker)</label><input id="xKey" placeholder="V√≠ d·ª•: bong-2025-super"/></div>
    </div>

    <label>Template Shopee</label>
    <input id="tplShopee" placeholder="https://go.isclix.com/deep_link/&lt;AFF_ID&gt;/475158...?..."/>

    <label>Template Lazada</label>
    <input id="tplLazada" placeholder="https://go.isclix.com/deep_link/&lt;AFF_ID&gt;/512714...?..."/>

    <label>Template TikTok</label>
    <input id="tplTiktok" placeholder="https://go.isclix.com/deep_link/&lt;AFF_ID&gt;/664852...?..."/>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnDetectAff">T·ª± ƒë·ªông l·∫•y t·ª´ /assets/mxd-affiliate.js</button>
      <span class="small" id="affStatus"></span>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnSaveSettings">üíæ L∆∞u</button>
      <button class="btn" id="btnLoadSettings">‚Üª T·∫£i</button>
      <button class="btn" id="btnClearSettings">üóë Xo√° c√†i ƒë·∫∑t</button>
      <span class="small" id="settingsStatus"></span>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnCheckWorker">Ki·ªÉm tra Worker</button>
      <button class="btn" id="btnCheckAuth">Ki·ªÉm tra X-Key</button>
      <button class="btn" id="btnCheckWrite">Ki·ªÉm tra quy·ªÅn commit</button>
      <button class="btn" id="btnTestUpload">Test upload 1√ó1</button>
      <span class="small" id="workerStatus"></span>
    </div>
  </div>

  <div class="grid g2">
    <div class="card">
      <h2>2) ·∫¢nh s·∫£n ph·∫©m (ƒë∆°n l·∫ª)</h2>
      <div id="drop" class="drop">K√©o <b>m·ªôt ho·∫∑c nhi·ªÅu</b> ·∫£nh v√†o ƒë√¢y ho·∫∑c ch·ªçn‚Ä¶</div>
      <input type="file" id="file" accept="image/*" multiple style="display:none"/>
      <div class="row" style="margin-top:10px">
        <label class="w-auto" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="cbUseFilename" checked style="width:auto"/>
          D√πng <b>t√™n file</b> n·∫øu <b>SKU tr·ªëng</b>
        </label>
        <div class="w-auto">
          <label class="small" style="margin:0 0 4px">Th∆∞ m·ª•c m·∫∑c ƒë·ªãnh</label>
          <select id="defaultFolder">
            <option value="/assets/img/products/">/assets/img/products/</option>
            <option value="/assets/img/categories/">/assets/img/categories/</option>
            <option value="/assets/img/og/">/assets/img/og/</option>
            <option value="/assets/img/brands/">/assets/img/brands/</option>
            <option value="custom">T·ª± nh·∫≠p‚Ä¶</option>
          </select>
        </div>
        <div id="defaultCustomWrap" class="w-auto" style="display:none;min-width:280px">
          <label class="small" style="margin:0 0 4px">ƒê∆∞·ªùng d·∫´n tu·ª≥ ch·ªânh (k·∫øt th√∫c b·∫±ng /)</label>
          <input id="defaultCustomPath" placeholder="/assets/img/bongstudio/"/>
        </div>
        <div class="w-auto">
          <label class="small" style="margin:0 0 4px">ƒê·ªãnh d·∫°ng xu·∫•t m·∫∑c ƒë·ªãnh</label>
          <select id="defaultFmt">
            <option value="webp">webp</option>
            <option value="png">png</option>
          </select>
        </div>
      </div>

      <div id="imgPreview" class="preview" style="margin-top:10px;display:none">
        <img id="thumb" alt="preview"/>
        <div class="small">
          <div><b>T√™n file ƒë·ªÅ xu·∫•t:</b> <code class="inline" id="imgName">-</code></div>
          <div><b>K√≠ch th∆∞·ªõc:</b> <span id="imgInfo">-</span></div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSelectImg">Ch·ªçn ·∫£nh</button>
        <button class="btn" id="btnConvert">N√©n .webp</button>
        <button class="btn" id="btnSaveImg">T·∫£i ·∫£nh (.webp)</button>
        <button class="btn primary" id="btnUploadImg">Upload ·∫£nh ‚Üí /assets/img/products/&lt;sku&gt;.webp</button>
        <button class="btn" id="btnQueueCurrent">‚ûï Th√™m ·∫£nh hi·ªán t·∫°i v√†o h√†ng ƒë·ª£i</button>
      </div>
      <div class="small">Chu·∫©n: c·∫°nh d√†i ~1200px, WebP q=0.82. N√∫t ‚ûï s·∫Ω ƒë·∫©y ·∫£nh hi·ªán t·∫°i v√†o H√ÄNG ƒê·ª¢I.</div>
    </div>

    <div class="card">
      <h2>3) Th√¥ng tin s·∫£n ph·∫©m</h2>
      <div class="grid">
        <div class="row">
          <div><label>T√™n s·∫£n ph·∫©m</label><input id="name" data-clear placeholder="V√≠ d·ª•: √Åo thun n·ªØ c·ªï tr√≤n"/></div>
          <div><label>SKU (b·∫Øt bu·ªôc cho publish; c√≥ th·ªÉ tr·ªëng khi ch·ªâ upload ·∫£nh)</label><input id="sku" data-clear placeholder="ao-thun-nu-co-tron"/></div>
        </div>
        <div class="row">
          <div><label>Gi√° (VND, kh√¥ng ch·∫•m)</label><input id="price" data-clear type="number" placeholder="399000"/></div>
          <div><label>Merchant</label>
            <select id="merchant">
              <option value="shopee">shopee</option>
              <option value="lazada">lazada</option>
              <option value="tiktok">tiktok</option>
            </select>
          </div>
        </div>
        <div><label>Link g·ªëc (origin)</label><input id="origin" data-clear placeholder="https://shopee.vn/‚Ä¶"/></div>
        <div class="row">
          <div><label>·∫¢nh (ƒë∆∞·ªùng d·∫´n)</label><input id="image" data-clear placeholder="/assets/img/products/ao-thun-nu-co-tron.webp"/></div>
          <div>
            <label>Danh m·ª•c (category)</label>
            <input id="category" data-clear placeholder="gia-dung-decor / thoi-trang-nu / thoi-trang-nam / quan-ao-em-be / suc-khoe-tpcn / sach / do-an / khac" list="presetCats"/>
            <datalist id="presetCats">
              <option value="gia-dung-decor"></option>
              <option value="thoi-trang-nu"></option>
              <option value="thoi-trang-nam"></option>
              <option value="quan-ao-em-be"></option>
              <option value="suc-khoe-tpcn"></option>
              <option value="sach"></option>
              <option value="do-an"></option>
              <option value="khac"></option>
            </datalist>
          </div>
        </div>
        <div><label>Th∆∞∆°ng hi·ªáu (brand)</label><input id="brand" data-clear placeholder="brand, h√£ng‚Ä¶"/></div>
        <div class="row">
          <label style="display:flex;align-items:center;gap:8px;flex:unset">
            <input type="checkbox" id="featured" style="width:auto"/> N·ªïi b·∫≠t (featured)
          </label>
          <label style="display:flex;align-items:center;gap:8px;flex:unset">
            <input type="checkbox" id="status" checked style="width:auto"/> Hi·ªÉn th·ªã (status)
          </label>
          <button class="btn" id="btnAuto">ƒêi·ªÅn auto t·ª´ t√™n</button>
        </div>
        <div id="diag" class="small"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>2b) H√†ng ƒë·ª£i ·∫£nh (Batch)</h2>
    <div class="row">
      <button class="btn" id="btnConvertAll">Convert t·∫•t c·∫£</button>
      <button class="btn" id="btnDownloadAll">T·∫£i t·∫•t c·∫£</button>
      <button class="btn primary" id="btnUploadAll">Upload t·∫•t c·∫£</button>
      <button class="btn" id="btnClearQueue">üóë Xo√° h√†ng ƒë·ª£i</button>
    </div>
    <div style="overflow:auto;margin-top:10px">
      <table class="queue" id="queueBodyWrap">
        <thead>
        <tr>
          <th>·∫¢nh</th><th>T√™n xu·∫•t</th><th>Th∆∞ m·ª•c</th><th>ƒê·ªãnh d·∫°ng</th><th>ƒê∆∞·ªùng d·∫´n xu·∫•t</th><th>K√≠ch th∆∞·ªõc</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th>
        </tr>
        </thead>
        <tbody id="queueBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h2>4) Deep-link</h2>
    <div class="grid g2">
      <div>
        <label>Origin (ƒë√£ nh·∫≠p)</label>
        <textarea id="originOut" class="deeplink-text" readonly></textarea>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="copyOrigin">Copy Origin</button>
          <button class="btn" id="openOrigin">M·ªü Origin</button>
        </div>
      </div>
      <div>
        <label>Affiliate deep-link</label>
        <div class="row">
          <textarea id="deeplink" data-clear placeholder="T·ª± sinh t·ª´ template ho·∫∑c d√°n s·∫µn t·∫°i ƒë√¢y"></textarea>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="btnMakeDeeplink">T·∫°o t·ª´ template</button>
          <button class="btn" id="copyDeeplink">Copy Deep-link</button>
          <button class="btn" id="btnOpenDeeplink">M·ªü Deep-link</button>
          <span id="dlCheck" class="badge">‚Äì</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>5) JSON xu·∫•t b·∫£n</h2>
    <textarea id="jsonOut" rows="8" spellcheck="false"></textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnToJson">T·∫°o JSON</button>
      <button class="btn" id="btnCopyJson">Copy JSON</button>
      <button class="btn" id="btnDownloadJson">T·∫£i bongstudio-product.json</button>
    </div>
  </div>

  <div class="card">
    <h2>6) Worker Debug</h2>
    <div class="row">
      <button class="btn" id="btnProbeOptions">Probe OPTIONS /upload-image</button>
      <button class="btn" id="btnProbePublish">Probe OPTIONS /git/json</button>
      <span class="small muted">Log d∆∞·ªõi gi√∫p ph√¢n bi·ªát: CORS / Auth / Payload.</span>
    </div>
    <div id="debugLog" class="small" style="background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px;max-height:220px;overflow:auto">‚Äì</div>
  </div>

  <div class="sticky-actions row">
    <button class="btn primary" id="btnPublish">Publish ‚Üí L∆∞u JSON</button>
    <button class="btn" id="btnPublishFeatured">Publish ‚Üí L∆∞u JSON + N·ªïi b·∫≠t</button>
    <button class="btn" id="btnVerify">‚úÖ Ki·ªÉm tra file JSON</button>
    <button class="btn" id="btnGenCommit">Gen commit message</button>
    <input id="commitMsg" readonly/>
  </div>

  <div class="toast" id="toast"></div>
</div>

<script>
/* ===== MXD-TOOL v4.3.9-pro4 ‚Äî Bongstudio edition ===== */
function initImporter() {
  const $ = s => document.querySelector(s);

  /* SITE_ID theo hostname */
  const SITE_ID = (() => {
    const h=(location.hostname||'').toLowerCase(); const m=h.match(/^([a-z0-9-]+)/);
    return (m?m[1]:'mxd').replace(/[^a-z0-9-]/g,'')||'mxd';
  })();

  /* JSON base cho Bongstudio */
  const JSON_BASE = "/assets/json/bongstudio/";

  document.title = `${SITE_ID} Importer v4.3.9 ‚Äî PRO + Batch + Featured + Debug`;
  const titleEl=$("#title");
  if(titleEl) titleEl.innerHTML = `${SITE_ID} Importer v4.3.9 <span class="pill">PRO</span> <span class="pill">Batch</span> <span class="pill">Featured</span> <span class="pill">Debug</span>`;

  const slugify = s => s.toString()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/ƒë/g,'d').replace(/ƒê/g,'D')
    .toLowerCase().replace(/[^a-z0-9]+/g,'-')
    .replace(/^-+|-+$/g,'');

  const LS_KEY = `MXD_IMPORTER_SETTINGS_V439PRO4_${SITE_ID.toUpperCase()}`;

  /* Default template AFF cho Bongstudio (c·∫≠u ƒë∆∞a) */
  const DEFAULT_TPL = {
    shopee: "https://go.isclix.com/deep_link/6837508078414670452/4751584435713464237?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}",
    lazada: "https://go.isclix.com/deep_link/6837508078414670452/5127144557053758578?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}",
    tiktok: "https://go.isclix.com/deep_link/6837508078414670452/6648523843406889655?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}"
  };

  const state = { imgBlob:null, imgName:null, imgW:0, imgH:0 };

  /* UI helpers */
  function toast(msg,cls=''){ const t=$("#toast"); t.innerHTML=msg; t.className='toast show '+cls; setTimeout(()=>t.className='toast',4200); }
  function log(msg){ const d=$("#debugLog"); d.textContent = (d.textContent && d.textContent!=='‚Äì' ? d.textContent + "\n" : "") + msg; d.scrollTop = d.scrollHeight; }
  function showWarn(v){ $("#affWarn").style.display = v ? 'block' : 'none'; }
  function updateToastOffset(){ const bar=document.querySelector('.sticky-actions'); const bottom=bar?(bar.offsetHeight+16):12; document.documentElement.style.setProperty('--toast-bottom', bottom+'px'); }
  updateToastOffset(); window.addEventListener('resize', updateToastOffset);

  /* Theme + quick clears */
  $("#btnMode").onclick=()=>{
    document.body.classList.toggle('dark');
    $("#btnMode").textContent=document.body.classList.contains('dark')?'Light mode':'Dark mode';
  };
  $("#btnClearLog").onclick=()=>{ $("#debugLog").textContent='‚Äì'; toast('ƒê√£ xo√° log.'); };
  $("#btnClearFormQuick").onclick=()=>{
    document.querySelectorAll('[data-clear]').forEach(el=>el.value='');
    $("#featured").checked=false;
    $("#status").checked=true;
    $("#sku").dispatchEvent(new Event('input'));
    $("#imgPreview").style.display='none';
    toast('ƒê√£ xo√° form.');
  };

  /* Settings */
  function readSettings(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(_){ return {}; } }
  function writeSettings(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }
  function uiToSettings(){
    return {
      workerUrl:$("#workerUrl").value.trim(),
      xKey:$("#xKey").value.trim(),
      tplShopee:$("#tplShopee").value.trim(),
      tplLazada:$("#tplLazada").value.trim(),
      tplTiktok:$("#tplTiktok").value.trim(),
      defaultFolder:$("#defaultFolder").value,
      defaultCustomPath:$("#defaultCustomPath").value.trim(),
      defaultFmt:$("#defaultFmt").value
    };
  }
  function settingsToUi(s){
    $("#workerUrl").value=s.workerUrl||'';
    $("#xKey").value=s.xKey||'';
    $("#tplShopee").value=s.tplShopee||'';
    $("#tplLazada").value=s.tplLazada||'';
    $("#tplTiktok").value=s.tplTiktok||'';
    if(s.defaultFolder) $("#defaultFolder").value=s.defaultFolder;
    if(s.defaultCustomPath) $("#defaultCustomPath").value=s.defaultCustomPath;
    if(s.defaultFmt) $("#defaultFmt").value=s.defaultFmt;
    ensureFolderBase(); updateSingleUploadCta();
    checkAffTemplatesWarn();
  }
  function saveSettings(){
    writeSettings(uiToSettings());
    $("#settingsStatus").textContent="ƒê√£ l∆∞u.";
    toast("ƒê√£ l∆∞u c√†i ƒë·∫∑t.","ok");
    checkAffTemplatesWarn();
  }
  function loadSettings(){
    const s=readSettings();
    settingsToUi(s);
    $("#settingsStatus").textContent="ƒê√£ t·∫£i c√†i ƒë·∫∑t.";
  }
  $("#btnSaveSettings").onclick=saveSettings;
  $("#btnLoadSettings").onclick=loadSettings;
  $("#btnClearSettings").onclick=()=>{
    localStorage.removeItem(LS_KEY);
    settingsToUi({});
    $("#settingsStatus").textContent="ƒê√£ x√≥a.";
    toast('ƒê√£ xo√° c√†i ƒë·∫∑t.');
    checkAffTemplatesWarn();
  };
  loadSettings();

  /* T·ª± ƒë·ªông l·∫•y ID t·ª´ /assets/mxd-affiliate.js (n·∫øu c√≥) */
  async function autodetectAff(){
    $("#affStatus").textContent="ƒêang d√≤ /assets/mxd-affiliate.js‚Ä¶";
    try{
      const r=await fetch('/assets/mxd-affiliate.js',{cache:'no-cache'});
      const txt=await r.text();
      const idRe=/go\.isclix\.com\/deep_link\/(\d+)\/(\d+)/g;
      let firstId=''; const found={};
      for(const m of txt.matchAll(idRe)){
        const aid=m[1], adv=m[2];
        if(!firstId) firstId=aid;
        found[adv]=aid;
      }
      const ADV = {
        shopee: '4751584435713464237',
        lazada: '5127144557053758578',
        tiktok: '6648523843406889655'
      };
      const s=readSettings();
      const aidShopee = found[ADV.shopee] || firstId;
      const aidLazada = found[ADV.lazada] || firstId;
      const aidTiktok = found[ADV.tiktok] || firstId;

      if(!aidShopee && !aidLazada && !aidTiktok){
        $("#affStatus").textContent="Kh√¥ng t√¨m ƒë∆∞·ª£c ID trong mxd-affiliate.js. D√°n th·ªß c√¥ng gi√∫p m√¨nh.";
        showWarn(true);
        return;
      }
      const tplShopee = aidShopee ? `https://go.isclix.com/deep_link/${aidShopee}/${ADV.shopee}?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}` : '';
      const tplLazada = aidLazada ? `https://go.isclix.com/deep_link/${aidLazada}/${ADV.lazada}?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}` : '';
      const tplTiktok = aidTiktok ? `https://go.isclix.com/deep_link/${aidTiktok}/${ADV.tiktok}?url={url}&sub1={sub1}&sub2={sub2}&sub3={sub3}&sub4={sub4}` : '';
      $("#tplShopee").value = tplShopee;
      $("#tplLazada").value = tplLazada;
      $("#tplTiktok").value = tplTiktok;
      writeSettings({...s, tplShopee, tplLazada, tplTiktok});
      $("#affStatus").textContent="ƒê√£ ƒëi·ªÅn template t·ª´ mxd-affiliate.js v√† l∆∞u.";
      showWarn(false);
    }catch(e){
      $("#affStatus").textContent="Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c mxd-affiliate.js: "+e.message;
      showWarn(true);
    }
  }
  $("#btnDetectAff").onclick=autodetectAff;

  function checkAffTemplatesWarn(){
    const s=readSettings();
    const haveUser = s.tplShopee || s.tplLazada || s.tplTiktok;
    const haveDefault = DEFAULT_TPL.shopee || DEFAULT_TPL.lazada || DEFAULT_TPL.tiktok;
    const bad = !(haveUser || haveDefault);
    showWarn(bad);
  }

  /* Headers + baseUrl + checks */
  function hdr(method='GET', useKey=true){
    const h={};
    if(['POST','PUT','PATCH'].includes(method)) h['content-type']='application/json';
    const s=readSettings();
    if(useKey && s.xKey) h['x-key']=s.xKey;
    return h;
  }
  async function check(url, useKey=false){
    try{
      const r=await fetch(url,{mode:"cors",cache:"no-cache",headers:hdr('GET',useKey)});
      const text=await r.text().catch(()=>'' );
      return {ok:r.ok,status:r.status,text};
    }catch(e){
      return {ok:false,status:-1,text:String(e)};
    }
  }
  function baseUrl(){
    const s=readSettings();
    return (s.workerUrl||'').replace(/\/$/,'');
  }

  $("#btnCheckWorker").onclick=async()=>{
    const b=baseUrl(); if(!b){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
    const u=b+"/health";
    const r=await check(u,false);
    const msg=r.ok?`Worker OK (${r.status})`:`Worker l·ªói (${r.status})`;
    $("#workerStatus").textContent=msg;
    log("[/health] "+msg+" ‚Äî "+r.text.slice(0,120));
    toast(msg, r.ok?"ok":"err");
  };
  $("#btnCheckAuth").onclick=async()=>{
    const b=baseUrl(); if(!b){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
    const u=b+"/whoami";
    const r=await check(u,true);
    const msg=r.ok?"X-Key h·ª£p l·ªá.":"X-Key kh√¥ng h·ª£p l·ªá ("+r.status+")";
    log("[/whoami] "+msg+" ‚Äî "+r.text.slice(0,120));
    toast(msg, r.ok?"ok":"err");
  };
  $("#btnCheckWrite").onclick=async()=>{
    const b=baseUrl(); if(!b){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
    const u=b+"/can-write";
    const r=await check(u,true);
    const msg=r.ok?"C√≥ quy·ªÅn commit.":"Kh√¥ng c√≥ quy·ªÅn ("+r.status+")";
    log("[/can-write] "+msg+" ‚Äî "+r.text.slice(0,120));
    toast(msg, r.ok?"ok":"err");
  };
  $("#btnProbeOptions").onclick=async()=>{
    const b=baseUrl(); if(!b){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
    try{
      const r=await fetch(b+"/upload-image",{method:"OPTIONS",mode:"cors",cache:"no-cache",headers:hdr('OPTIONS',true)});
      log(`[OPTIONS /upload-image] ${r.status}`);
      toast("Probe OPTIONS /upload-image","ok");
    }catch(e){
      log("[OPTIONS /upload-image] L·ªói: "+e.message);
      toast("Probe l·ªói.","err");
    }
  };
  $("#btnProbePublish").onclick=async()=>{
    const b=baseUrl(); if(!b){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
    try{
      const r=await fetch(b+"/git/json",{method:"OPTIONS",mode:"cors",cache:"no-cache",headers:hdr('OPTIONS',true)});
      log(`[OPTIONS /git/json] ${r.status}`);
      toast("Probe OPTIONS /git/json","ok");
    }catch(e){
      log("[OPTIONS /git/json] L·ªói: "+e.message);
      toast("Probe l·ªói.","err");
    }
  };
  $("#btnTestUpload").onclick=async()=>{
    const b=baseUrl(); if(!b){ toast("Ch∆∞a c·∫•u h√¨nh Worker.","warn"); return; }
    const c=document.createElement('canvas');
    c.width=1; c.height=1;
    const blob=await new Promise(res=>c.toBlob(res,'image/webp',0.5));
    const dataUrl=await blobToDataURL(blob);
    try{
      const r=await fetch(b+'/upload-image',{
        method:'POST',mode:'cors',cache:"no-cache",
        headers:hdr('POST',true),
        body:JSON.stringify({sku:'ping',path:'/assets/img/test/ping.webp',file:dataUrl})
      });
      log(`[TEST UPLOAD] ${r.status} ${r.ok?'OK':'FAIL'}`);
      toast(r.ok?'Test upload OK':'Test upload FAIL '+r.status, r.ok?'ok':'err');
    }catch(e){
      log("[TEST UPLOAD] L·ªói: "+e.message);
      toast("Test upload l·ªói.","err");
    }
  };

  /* Deep-link helpers */
  const vn = s => (s||'').toString()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/ƒë/g,'d').replace(/ƒê/g,'D')
    .toLowerCase();

  function computeSubs(sku, merchant){
    return {
      sub1: sku||'sku',
      sub2:(merchant||'merchant').toLowerCase(),
      sub3:'tool',
      sub4:SITE_ID
    };
  }
  function ensureSubsInUrl(u, subs){
    const has = k => new RegExp(`[?&]${k}=`,`i`).test(u);
    const qs=[];
    for(const k of ['sub1','sub2','sub3','sub4'])
      if(!has(k)) qs.push(`${k}=${encodeURIComponent(subs[k])}`);
    return qs.length?(u+(u.includes('?')?'&':'?')+qs.join('&')):u;
  }
  function cleanUrl(u){ return (u||'').trim().replace(/^["']+|["',]+$/g,''); }

  function activeTplFor(merchant){
    const s=readSettings();
    const pick = merchant==='lazada'
      ? (s.tplLazada || DEFAULT_TPL.lazada)
      : (merchant==='tiktok'
          ? (s.tplTiktok || DEFAULT_TPL.tiktok)
          : (s.tplShopee || DEFAULT_TPL.shopee));
    return pick || '';
  }

  function validateDeeplink(){
    const dl=$("#deeplink").value.trim();
    const badge=$("#dlCheck");
    if(!dl){ badge.textContent="ch∆∞a c√≥ deeplink"; badge.className='badge'; return; }
    const okHost=/(^https?:\/\/)?([^/]*\.)?isclix\.com/i.test(dl);
    const hasUrl=/[?&]url=/.test(dl);
    const need=['sub1','sub2','sub3','sub4'];
    const missing=need.filter(k=>!new RegExp(`[?&]${k}=`).test(dl));
    if(okHost && hasUrl && missing.length===0){
      badge.textContent="OK affiliate"; badge.className='badge'; return;
    }
    if(okHost && !hasUrl){
      badge.textContent="isclix thi·∫øu url="; badge.className='badge'; return;
    }
    if(okHost){
      badge.textContent="thi·∫øu: "+missing.join(', '); badge.className='badge'; return;
    }
    badge.textContent="KH√îNG qua affiliate"; badge.className='badge';
  }

  function makeDeeplink(){
    const origin=cleanUrl($("#origin").value.trim());
    const sku=$("#sku").value.trim();
    const merchant=$("#merchant").value;
    if(!origin){ toast("Thi·∫øu Origin.","warn"); return; }
    const tpl=activeTplFor(merchant);
    if(!tpl){
      toast("Ch∆∞a c·∫•u h√¨nh template "+merchant.toUpperCase()+". V√†o C√†i ƒë·∫∑t ƒë·ªÉ ƒëi·ªÅn/auto-detect.", "warn");
      showWarn(true);
      return;
    }
    const subs=computeSubs(sku,merchant);
    let link=tpl
      .replace(/\{url\}/g,encodeURIComponent(origin))
      .replace(/\{sku\}/g,sku||'sku')
      .replace(/\{sub1\}/g,subs.sub1)
      .replace(/\{sub2\}/g,subs.sub2)
      .replace(/\{sub3\}/g,subs.sub3)
      .replace(/\{sub4\}/g,subs.sub4);
    link=ensureSubsInUrl(link,subs);
    $("#deeplink").value=link;
    validateDeeplink();
  }

  $("#btnMakeDeeplink").onclick=makeDeeplink;
  $("#deeplink").addEventListener('input', validateDeeplink);
  $("#copyOrigin").onclick=()=>{
    const t=$("#originOut"); t.select(); document.execCommand('copy');
    toast("ƒê√£ copy Origin.","ok");
  };
  $("#openOrigin").onclick=()=>{
    const u=$("#originOut").value.trim()||$("#origin").value.trim();
    if(u){ window.open(u,'_blank'); } else { toast("Ch∆∞a c√≥ Origin.","warn"); }
  };
  $("#copyDeeplink").onclick=()=>{
    const t=$("#deeplink"); t.select(); document.execCommand('copy');
    toast("ƒê√£ copy Deep-link.","ok");
  };
  $("#btnOpenDeeplink").onclick=()=>{
    const u=$("#deeplink").value.trim();
    if(u){ window.open(u,'_blank'); } else { toast("Ch∆∞a c√≥ Deep-link.","warn"); }
  };

  /* Category helpers cho b·ªô danh m·ª•c Bongstudio */
  function guessCategory(text){
    const t = vn(text);

    if(/\b(sach|sach giao khoa|truyen|tieu thuyet|book)\b/.test(t)) return 'sach';
    if(/\b(banh|keo|snack|mi|m√¨|gao|g·∫°o|do an|thuc an|an vat)\b/.test(t)) return 'do-an';
    if(/\b(gia dung|noi|chao|noi com|noi c∆°m|noi chien|noi-chien|noi-chien|noi-chien-khong-dau|bep|sofa|ke|k·ªá|den|ƒë√®n|decor|trang tri|nha cua)\b/.test(t)) return 'gia-dung-decor';
    if(/\b(em be|tre em|tre-so-sinh|so sinh|sosinh|baby|kids|nhi dong)\b/.test(t)) return 'quan-ao-em-be';
    if(/\b(vitamin|collagen|omega|tp chuc nang|thuc pham chuc nang|tpcn|suc khoe)\b/.test(t)) return 'suc-khoe-tpcn';

    // th·ªùi trang n·ªØ vs nam
    if(/\b(ao|√°o|quan|qu·∫ßn|dam|ƒë·∫ßm|chan vay|ch√¢n v√°y|vay|v√°y|jum|jumpsuit)\b/.test(t)){
      if(/\b(nu|n·ªØ|co gai|phu nu)\b/.test(t))
